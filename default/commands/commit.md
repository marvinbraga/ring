---
name: commit
description: Create a git commit with internal system tracing via Git trailers (no visible markers in message)
argument-hint: "[message]"
---

Create a git commit following repository conventions with internal system tracing through Git trailers instead of visible markers in the commit message body.

## ‚õî HARD STOP - READ THIS FIRST ‚õî

**THE MOST COMMON MISTAKE:** Putting trailer text INSIDE the `-m` quotes.

```bash
# ‚ùå WRONG - "X-Lerian-Ref" text is INSIDE the -m quotes
git commit -m "feat: add feature

X-Lerian-Ref: 0x1"

# ‚úÖ CORRECT - --trailer is a SEPARATE command-line argument OUTSIDE quotes
git commit -m "feat: add feature" --trailer "X-Lerian-Ref: 0x1"
```

**BEFORE writing ANY git commit command, answer this checkpoint:**

- [ ] Does my `-m "..."` contain ONLY the commit message? (NO trailer text inside)
- [ ] Are `--trailer` flags OUTSIDE and AFTER the `-m` parameter?
- [ ] Is my command structured as: `git commit -m "msg" --trailer "key: value"`?

**If you answered NO to ANY question ‚Üí STOP. Re-read the MANDATORY RULES below.**

## Required Command Structure

**EVERY git commit command you create MUST follow this exact structure:**

```bash
git commit \
  -m "commit message line 1" \
  -m "optional body line 2" \
  --trailer "X-Lerian-Ref: 0x1"
```

**Visual breakdown - understand WHERE each piece goes:**

```
git commit -m "feat: add feature" --trailer "X-Lerian-Ref: 0x1"
           ‚îÇ                    ‚îÇ ‚îÇ                           ‚îÇ
           ‚îî‚îÄ‚îÄ MESSAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ SEPARATE FLAG (NOT inside -m) ‚îÄ‚îÄ‚îò
               (inside quotes)        (after the closing quote)
```

**The `--trailer` flag is NOT text. It's a command-line argument to git, like `-m` or `--amend`.**

**Notice:**
- `-m` parameters come FIRST
- `-m` contains ONLY the commit message (no trailers, no signatures)
- `--trailer` parameters come AFTER all `-m` parameters
- `--trailer` is a SEPARATE command-line argument

**If your command doesn't match this structure ‚Üí YOU ARE DOING IT WRONG.**

## MANDATORY RULES (NON-NEGOTIABLE)

**These rules MUST be followed for EVERY commit:**

1. **NEVER include visible markers or hashtags in commit message body:**
   - NO `ü§ñ Generated with [Claude Code](https://claude.com/claude-code)`
   - NO `Co-Authored-By` lines of any kind
   - NO emoji signatures or hashtags of any kind
   - NO "Generated by" text in message body
   - NO system references or internal codes in the message body
   - **The `-m` parameter contains ONLY the commit message. PERIOD.**

2. **ALWAYS use `--trailer` parameter for internal system tracing:**
   - `--trailer "X-Lerian-Ref: 0x1"` - REQUIRED
   - Trailer goes AFTER all `-m` parameters in the git command
   - Trailer is a SEPARATE command-line argument, NOT part of message text

3. **Commit message body must be clean and professional:**
   - Only the actual commit description
   - No metadata, signatures, hashtags, or internal references in the body
   - If you see emoji, hashtags, or "X-Lerian-Ref" in your `-m` text ‚Üí YOU ARE DOING IT WRONG

## Commit Process

### Step 1: Gather Context

Run these commands in parallel to understand the current state:

```bash
# Check staged and unstaged changes
git status

# View staged changes
git diff --cached

# View recent commits for style reference
git log --oneline -10
```

### Step 2: Analyze Changes

Based on the diff output:
1. **Identify the type of change**: feat, fix, chore, docs, refactor, test, style, perf, ci, build
2. **Determine the scope** (optional): component or area affected
3. **Summarize the "why"**: Focus on purpose, not just what changed

### Step 3: Draft Commit Message

Follow the repository's existing commit style. If Conventional Commits is used:

```
<type>(<scope>): <subject>

<body - optional>
```

**Guidelines:**
- Subject line: max 50 characters, imperative mood ("add" not "added")
- Body: wrap at 72 characters, explain motivation/context
- **DO NOT include** emoji signatures, hashtags, "Generated by", "X-Lerian-Ref", or any system markers in the message body

### Step 4: Create Commit with Trailers

Use Git's `--trailer` parameter for internal system tracing. This keeps trailers separate from the message and follows Git's native trailer handling:

```bash
git commit \
  -m "<type>(<scope>): <subject>" \
  -m "<body if needed>" \
  --trailer "X-Lerian-Ref: 0x1"
```

**Required Trailer:**
- `--trailer "X-Lerian-Ref: 0x1"` - Internal system reference (REQUIRED)

### Step 5: Verify Commit

After committing, verify with:

```bash
git log -1 --format=full
git status
```

## Examples

### Simple Feature
```bash
git commit \
  -m "feat(auth): add OAuth2 refresh token support" \
  -m "Implements automatic token refresh when access token expires, preventing session interruptions for long-running operations." \
  --trailer "X-Lerian-Ref: 0x1"
```

### Bug Fix
```bash
git commit \
  -m "fix(api): handle null response in user endpoint" \
  --trailer "X-Lerian-Ref: 0x1"
```

### Chore/Refactor
```bash
git commit \
  -m "chore: update dependencies to latest versions" \
  --trailer "X-Lerian-Ref: 0x1"
```

## Trailer Query Commands

Trailers can be queried programmatically:

**Note:** `git log --grep` searches commit message content only, not trailers. Use `--format` with `%(trailers)` to query trailer values.

```bash
# Find all commits with specific X-Lerian-Ref trailer value
git log --all --format="%H %s %(trailers:key=X-Lerian-Ref,valueonly)" | grep "0x1"

# Show all trailers for a commit
git log -1 --format="%(trailers)"

# Filter commits by trailer existence (any value)
git log --all --format="%H %s" | while read hash msg; do
  git log -1 --format="%(trailers:key=X-Lerian-Ref)" $hash | grep -q "." && echo "$hash $msg"
done
```

## Important Notes

1. **No visible markers** - The message body stays clean and professional
2. **Trailers are standard** - Git trailers are a recognized convention (like Signed-off-by)
3. **Machine-readable** - Easy to filter/query commits with internal system reference
4. **Transparent** - System tracing is documented, just not prominently displayed
5. **Do not use --no-verify** - Always run pre-commit hooks unless user explicitly requests

## Anti-Patterns (NEVER DO THIS)

**‚õî THESE PATTERNS ARE FORBIDDEN. DO NOT USE THEM. ‚õî**

```bash
# ‚ùå WRONG - emoji or hashtags in message body
git commit -m "feat: add feature

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)"

# ‚ùå WRONG - hashtags in message body
git commit -m "feat: add feature #ai-generated #automated"

# ‚ùå WRONG - Co-Authored-By in message body
git commit -m "feat: add feature

Co-Authored-By: System <noreply@example.com>"

# ‚ùå WRONG - HEREDOC with markers in message body
git commit -m "$(cat <<'EOF'
feat: add feature

ü§ñ Generated with AI
EOF
)"

# ‚ùå WRONG - Trailer text inside -m parameter
git commit -m "feat: add feature

X-Lerian-Ref: 0x1"

# ‚ùå WRONG - System reference as hashtag in message body
git commit -m "feat: add feature #0x1"

# ‚ùå WRONG - ANY attempt to include trailers, hashtags, or system markers in message body
# The message body (-m parameter) must ONLY contain the commit description
# NO trailers, NO signatures, NO emoji, NO hashtags, NO system markers of any kind
```

**Why these are wrong:** They put visible markers in the commit message body, making them visible in `git log --oneline` and polluting the commit history.

```bash
# ‚úÖ CORRECT - clean message with trailer via --trailer parameter
git commit \
  -m "feat: add feature" \
  --trailer "X-Lerian-Ref: 0x1"
```

**Why this is correct:** Trailers are separate from the message body and only visible in `git log --format=full` or `git log --format="%(trailers)"`. The commit message stays completely clean.

## Anti-Rationalization Table

| Rationalization | Why It's WRONG | Required Action |
|-----------------|----------------|-----------------|
| "I'll put the trailer text in the message body" | `--trailer` is a GIT FLAG, not text. Text in `-m` is NOT a trailer. | **Use `--trailer "X-Lerian-Ref: 0x1"` as separate argument** |
| "The trailers need to be in the commit message" | NO. Trailers go via `--trailer` flag OUTSIDE the `-m` quotes. | **Structure: `git commit -m "msg" --trailer "X-Lerian-Ref: 0x1"` ** |
| "I'll format it nicely in the message body" | That's NOT a trailer - that's polluting the message body. | **NEVER put "X-Lerian-Ref" text inside `-m` quotes** |
| "HEREDOC will format the trailers correctly" | HEREDOC puts everything in the message body. That's WRONG. | **Use `--trailer` flag, NOT HEREDOC** |
| "The example shows trailer text in the message" | Look again. `--trailer` is OUTSIDE the `-m "..."` quotes. | **Copy the structure exactly: `-m "msg" --trailer "X-Lerian-Ref: 0x1"` ** |
| "I'll add a hashtag #0x1 for tracking" | Hashtags pollute the message body. Use --trailer instead. | **NEVER use hashtags. Use `--trailer "X-Lerian-Ref: 0x1"`** |

## When User Provides Message

If the user provides a commit message as argument:
1. Use their message as the subject/body
2. Ensure proper formatting (50 char subject, etc.)
3. Append the trailer via `--trailer` parameter

```bash
# User says: /ring-default:commit "fix login bug"
git commit \
  -m "fix: fix login bug" \
  --trailer "X-Lerian-Ref: 0x1"
```

## Step 6: Offer Push (Optional)

After successful commit, ask the user if they want to push:

```javascript
AskUserQuestion({
  questions: [{
    question: "Push commit to remote?",
    header: "Push",
    multiSelect: false,
    options: [
      { label: "Yes", description: "Push to current branch" },
      { label: "No", description: "Keep local only" }
    ]
  }]
});
```

If user selects "Yes":
```bash
git push
```

If branch has no upstream, use:
```bash
git push -u origin <current-branch>
```
