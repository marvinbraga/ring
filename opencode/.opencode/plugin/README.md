# Ring OpenCode Plugins

This directory contains TypeScript plugins that port Ring's hook system to OpenCode.

## Plugins Overview

| Plugin | Ring Equivalent | OpenCode Event | Description |
|--------|-----------------|----------------|-------------|
| `session-start.ts` | `session-start.sh` | `session.created` | Context injection at session start |
| `context-injection.ts` | `session-start.sh` (compact) | `experimental.session.compacting` | Preserve context during compaction |
| `ledger-save.ts` | `ledger-save.sh` | `experimental.session.compacting`, `session.idle` | Save continuity ledger before compact/end |
| `session-outcome.ts` | `session-outcome.sh` | `session.compacted`, `session.created` | Prompt for session outcome grade |
| `artifact-index-write.ts` | `artifact-index-write.sh` | `tool.execute.after` | Index handoffs/plans on write |
| `task-completion-check.ts` | `task-completion-check.sh` | `todo.updated` | Detect all todos complete |
| `instruction-reminder.ts` | `claude-md-reminder.sh` | `message.updated` | Re-inject instruction files |
| `context-usage-check.ts` | `context-usage-check.sh` | `message.updated` | Context usage warnings |
| `outcome-inference.ts` | `outcome_inference.py` | `session.idle` | Infer session outcome |
| `learning-extract.ts` | `learning-extract.py` | `session.idle` | Extract session learnings |
| `notification.ts` | N/A | `session.idle` | Desktop notifications |
| `env-protection.ts` | N/A | `tool.execute.before` | Protect sensitive files |
| `doubt-resolver.ts` | N/A | Tool: `ring_doubt` | Ask user to choose from options |

## Event Mapping

| Ring Event | OpenCode Event | Notes |
|------------|----------------|-------|
| `SessionStart` | `session.created` | No matcher support |
| `UserPromptSubmit` | `message.updated` | Workaround via message count tracking; filter user messages only |
| `PostToolUse` | `tool.execute.after` | Filter by `input.tool` (case-insensitive) |
| `PreCompact` | `experimental.session.compacting` | Direct mapping |
| `Stop` | `session.idle` | Fires when AI stops |
| N/A | `session.compacted` | After compaction complete (state-based workaround) |
| N/A | `todo.updated` | Todo list changes |

## State Management

State is persisted in `.opencode/state/` (with backward compat for `.ring/state/`):
- `{key}-{sessionId}.json` format
- Automatic cleanup of files >7 days old
- Atomic writes via temp file + rename with crypto random suffix
- Restrictive permissions (0o600) for sensitive data

## Session ID Handling

Session IDs are obtained from environment variables with secure fallback:
- Primary: `OPENCODE_SESSION_ID`
- Fallback: `CLAUDE_SESSION_ID`
- Secure fallback: Cryptographically random 16-byte hex (no process.ppid)

## Utilities

- `utils/state.ts` - State persistence helpers with path traversal protection
- `utils/message-tracking.ts` - Message count tracking for throttling

## Security Features

- **Path traversal protection**: All file paths validated against project root
- **Command injection prevention**: Uses Bun safe argument interpolation (avoid manual quoting)
- **SQL injection prevention**: Uses `better-sqlite3` with parameterized queries
- **Prompt injection prevention**: Content sanitization before injection
- **Secure temp files**: Crypto random suffix for atomic writes
- **Rate limiting**: Global limit on injections per minute

## Dependencies

**Source of truth:** `.opencode/package.json` (installed into `~/.config/opencode/package.json` by `opencode/installer.sh`).

Defined in `.opencode/package.json`:
- `@opencode-ai/plugin` - OpenCode plugin API (pinned)
- `better-sqlite3` - Safe SQL queries (exact version: 9.0.0)

- `@types/better-sqlite3` - Type definitions
- `@types/node` - Node.js type definitions
- `typescript` - TypeScript compiler

Integrity note: dependency integrity is enforced via `bun.lock` (hashes), generated by `bun install`.

## Testing

Run plugin tests:
```bash
cd opencode/.opencode
bun plugin/test-plugins.ts
```

## Known Limitations

1. **Real context usage**: Context estimation is based on message count, not actual API usage
2. **Event payload structure**: Some payload assumptions require verification against OpenCode's actual events
3. **message.updated double-counting**: Filters to user messages only but payload structure needs verification
