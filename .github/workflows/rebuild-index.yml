name: Rebuild Ring Index

on:
  push:
    branches:
      - main
    paths:
      # Rebuild when any component files change
      - '**/skills/*/SKILL.md'
      - '**/agents/*.md'
      - '**/commands/*.md'
      # Rebuild when extractor changes
      - 'tools/ring-cli/extractor/**'
  workflow_dispatch:
    # Allow manual trigger

# Prevent concurrent rebuilds
concurrency:
  group: rebuild-index
  cancel-in-progress: true

jobs:
  rebuild-index:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r tools/ring-cli/extractor/requirements.txt
          echo "=== Installed packages ==="
          pip freeze

      - name: Build index
        run: |
          cd tools/ring-cli/extractor
          python build_index.py --repo ${{ github.workspace }}

      - name: Verify index
        run: |
          # Check database was created
          if [ ! -f tools/ring-cli/ring-index.db ]; then
            echo "Error: ring-index.db was not created"
            exit 1
          fi

          # Check it has content (current: 87 skills + 45 agents + 32 commands â‰ˆ 164)
          COUNT=$(sqlite3 tools/ring-cli/ring-index.db "SELECT COUNT(*) FROM components")
          echo "Components in index: $COUNT"

          # FAIL if significantly below expected (80% threshold = ~130)
          if [ "$COUNT" -lt 130 ]; then
            echo "Error: Only $COUNT components indexed, expected ~164. Index appears incomplete."
            exit 1
          fi

          # WARN if slightly below expected
          if [ "$COUNT" -lt 160 ]; then
            echo "Warning: $COUNT components indexed, expected ~164"
          fi

          # Generate checksum for audit trail
          sha256sum tools/ring-cli/ring-index.db

      - name: Commit updated index
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if there are changes
          if git diff --quiet tools/ring-cli/ring-index.db; then
            echo "No changes to index"
            exit 0
          fi

          git add tools/ring-cli/ring-index.db
          git commit -m "chore: rebuild ring-index.db [skip ci]"
          git push
