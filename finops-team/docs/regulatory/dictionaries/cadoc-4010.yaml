# Data Dictionary: CADOC 4010
# Generated: 2025-11-25
# Authority: BACEN (Banco Central do Brasil)
# Created by: Interactive validation with user approval

metadata:
  template_code: "4010"
  template_name: "CADOC 4010 - Balancete Mensal"
  authority: "BACEN"
  format: "XML"
  frequency: "monthly"
  created_at: "2025-11-25"
  created_by: "interactive_validation"
  version: "1.0"

field_mappings:
  # Field 1: Código do Documento (Fixed)
  - field_code: "001"
    regulatory_field: "codigoDocumento"
    regulatory_name: "Código do Documento"
    required: true
    data_source: "PARAMETER"
    api_field: null
    transformation: "fixed"
    fixed_value: "4010"
    confidence: 100
    confidence_level: "HIGH"
    approved_by: "system"
    example_output: "4010"

  # Field 2: CNPJ (8 dígitos)
  - field_code: "002"
    regulatory_field: "cnpj"
    regulatory_name: "CNPJ da Instituição (Base)"
    required: true
    data_source: "midaz_onboarding"
    api_field: "organization.0.legal_document"
    transformation: "slice:':8'"
    confidence: 95
    confidence_level: "HIGH"
    approved_by: "user_selection"
    example_input: "12345678000190"
    example_output: "12345678"
    validation_pattern: "^\\d{8}$"

  # Field 3: Data Base
  - field_code: "003"
    regulatory_field: "dataBase"
    regulatory_name: "Data Base do Documento"
    required: true
    data_source: "reporter"
    api_field: null
    transformation: "date_time"
    format: "YYYY-MM"
    confidence: 100
    confidence_level: "HIGH"
    approved_by: "user_selection"
    example_output: "2025-11"
    validation_pattern: "^\\d{4}-\\d{2}$"

  # Field 4: Tipo de Remessa (Fixed - Initial)
  - field_code: "004"
    regulatory_field: "tipoRemessa"
    regulatory_name: "Tipo de Remessa"
    required: true
    data_source: "PARAMETER"
    api_field: null
    transformation: "fixed"
    fixed_value: "I"
    confidence: 100
    confidence_level: "HIGH"
    approved_by: "system"
    allowed_values: ["I", "S"]
    notes: "I=Inclusão (primeira remessa), S=Substituição"

  # Field 5: Código da Conta COSIF
  - field_code: "005"
    regulatory_field: "codigoConta"
    regulatory_name: "Código da Conta COSIF"
    required: true
    data_source: "midaz_transaction"
    api_field: "operation_route.code"
    transformation: "direct"
    iteration: true
    iteration_source: "midaz_transaction.operation_route"
    confidence: 75
    confidence_level: "MEDIUM"
    approved_by: "user_selection"
    example_output: "1000000009"
    validation_pattern: "^\\d{10}$"
    notes: "Código COSIF com 10 dígitos, incluindo dígito verificador"

  # Field 6: Saldo
  - field_code: "006"
    regulatory_field: "saldo"
    regulatory_name: "Saldo da Conta"
    required: true
    data_source: "midaz_transaction"
    api_field: "balance.available"
    transformation: "floatformat:2"
    iteration: true
    filter_by: "operation_route_id"
    confidence: 90
    confidence_level: "HIGH"
    approved_by: "user_selection"
    example_input: 1234567.8912
    example_output: "1234567.89"
    validation_pattern: "^-?\\d+\\.\\d{2}$"

xml_structure:
  root_element: "documento"
  root_attributes:
    - codigoDocumento
    - cnpj
    - dataBase
    - tipoRemessa
  child_elements:
    - name: "contas"
      type: "container"
      children:
        - name: "conta"
          type: "repeating"
          iteration_source: "operation_route"
          attributes:
            - codigoConta
            - saldo

validation_rules:
  - rule_id: "VR001"
    field: "cnpj"
    type: "format"
    pattern: "^\\d{8}$"
    message: "CNPJ deve ter exatamente 8 dígitos (base)"

  - rule_id: "VR002"
    field: "codigoConta"
    type: "format"
    pattern: "^\\d{10}$"
    message: "Código COSIF deve ter exatamente 10 dígitos"

  - rule_id: "VR003"
    field: "saldo"
    type: "format"
    pattern: "^-?\\d+\\.\\d{2}$"
    message: "Saldo deve ter 2 casas decimais"

  - rule_id: "VR004"
    field: "dataBase"
    type: "format"
    pattern: "^\\d{4}-\\d{2}$"
    message: "Data base deve estar no formato YYYY-MM"

  - rule_id: "VR005"
    field: "tipoRemessa"
    type: "enum"
    allowed_values: ["I", "S"]
    message: "Tipo de remessa deve ser I (Inclusão) ou S (Substituição)"

business_rules:
  - rule_id: "BR001"
    description: "Tipo remessa 'I' para primeira submissão, 'S' apenas para substituir documento já aceito"

  - rule_id: "BR002"
    description: "Contas com saldo zero são opcionais"

  - rule_id: "BR003"
    description: "Para documento 4016 (semestral), não incluir contas dos grupos 7 e 8"

reporter_patterns:
  date_function: "{% date_time 'YYYY-MM' %}"
  iteration_pattern: |
    {%- for route in midaz_transaction.operation_route %}
      {%- with balance = filter(midaz_transaction.balance, "operation_route_id", route.id)[0] %}
        ...
      {%- endwith %}
    {%- endfor %}
  filter_function: "filter(collection, field, value)"

pitfalls:
  - id: "PF001"
    field: "cnpj"
    issue: "Usar CNPJ completo (14 dígitos) ao invés de base (8 dígitos)"
    solution: "Sempre aplicar slice:':8' para extrair apenas os 8 primeiros dígitos"

  - id: "PF002"
    field: "codigoConta"
    issue: "Formato do código COSIF mudou em Jan/2025 para 6 níveis + dígito verificador"
    solution: "Verificar se operation_route.code está no formato correto de 10 dígitos"

  - id: "PF003"
    field: "saldo"
    issue: "Balance pode não existir para algumas operation_routes"
    solution: "Usar condição {%- if balance %} antes de acessar balance.available"
